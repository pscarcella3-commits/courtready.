<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CourtReady Pro</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* --- VARIABILI & RESET --- */
        :root { 
            --neon: #d4ff00; --bg: #000000; --card: #111111; --border: #222222; 
            --win: #d4ff00; --loss: #ff3333; --plan: #333333; 
        }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; height: 100%; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; outline: none; }

        /* --- VISTE --- */
        .view { display: none; height: 100%; width: 100%; flex-direction: column; overflow-y: auto; position: absolute; top: 0; left: 0; z-index: 1; }
        .view.active { display: flex; z-index: 2; }
        .content-scroll { padding-bottom: 180px; width: 100%; }

        /* --- OVERLAYS & MODALS --- */
        #setup-wizard, #match-detail, #recap-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: none; flex-direction: column; padding: 30px; align-items: center; justify-content: center; text-align: center; }
        #recap-overlay { z-index: 5000; padding: 40px 20px; overflow-y: auto; justify-content: flex-start; }
        .step-container { display: none; width: 100%; animation: fadeIn 0.5s; }
        .step-container.active { display: block; }

        /* --- CALENDARIO --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; border-radius: 10px; background: #080808; border: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #444; cursor: pointer; }
        .cal-cell.today { border-color: white; color: white; }
        .cal-cell.planned { background: var(--plan); color: #888; }
        .cal-cell.done { background: rgba(212, 255, 0, 0.15); border: 1px solid var(--win); color: var(--win); }
        .cal-cell.missed { background: rgba(255, 51, 51, 0.15); border: 1px solid var(--loss); color: var(--loss); }

        /* --- STILI ORIGINALI (COPIATI) --- */
        .logo-wrap { display: flex; align-items: center; justify-content: space-between; padding: 40px 25px 10px; }
        .court-logo { width: 35px; height: 35px; border: 2.5px solid var(--neon); border-radius: 4px; position: relative; }
        .court-logo::before { content: ''; position: absolute; top: 50%; width: 100%; height: 2px; background: var(--neon); }
        .court-logo::after { content: ''; position: absolute; left: 50%; top: 50%; width: 2px; height: 50%; background: var(--neon); transform: translateY(-50%); }
        .sport-tag { font-size: 9px; font-weight: 900; background: #222; padding: 4px 8px; border-radius: 6px; color: #888; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 10px 20px; position: relative; }
        .btn-neon { background: var(--neon); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 900; width: 100%; text-transform: uppercase; font-size: 14px; cursor: pointer; }
        
        .set-container { display: flex; gap: 8px; margin-bottom: 20px; }
        .set-macro { flex: 1; background: #080808; border: 1px solid #222; border-radius: 12px; padding: 10px 5px; text-align: center; }
        .score-box input { width: 32px; height: 32px; background: #1a1a1a; border: 1px solid #333; color: var(--neon); text-align: center; font-weight: 900; border-radius: 6px; }
        
        .opt-btn { background: #080808; border: 1px solid #222; padding: 12px 5px; border-radius: 12px; color: #666; font-size: 10px; font-weight: 800; cursor: pointer; text-align: center; }
        .opt-btn.active { border-color: var(--neon); color: var(--neon); }

        /* --- PLAYER --- */
        #immersive-session { position: fixed; inset: 0; background: #050505; z-index: 9000; display: none; flex-direction: column; overflow: hidden; }
        .progress-bar { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin: 20px 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--neon); transition: 1s linear; }

        .nav-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; height: 70px; background: rgba(15,15,15,0.95); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #222; z-index: 4000; }
        .nav-item { color: #444; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--neon); }
    </style>
</head>
<body>

    <div id="recap-overlay">
        <div onclick="this.parentElement.style.display='none'" style="color:var(--neon); font-weight:900; margin-bottom:20px; cursor:pointer; display:flex; align-items:center; gap:10px;"><i data-lucide="x"></i> CHIUDI RIEPILOGO</div>
        <div id="recap-content" style="width:100%;"></div>
    </div>

    <div id="setup-wizard">
        <div id="step-1" class="step-container active">
            <h1 style="font-weight: 900;">IL TUO CAMPO</h1>
            <button class="btn-neon" style="margin-bottom:10px;" onclick="saveStep1('TENNIS')">TENNIS</button>
            <button class="btn-neon" onclick="saveStep1('PADEL')">PADEL</button>
        </div>
        <div id="step-2" class="step-container">
            <h1 style="font-weight: 900;">PIANO SETTIMANALE</h1>
            <div id="day-selector" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:30px 0;">
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="1">L</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="2">M</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="3">M</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="4">G</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="5">V</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="6">S</div>
                <div class="opt-btn" onclick="this.classList.toggle('active')" data-d="0">D</div>
            </div>
            <button class="btn-neon" onclick="finishSetup()">COMPLETA</button>
        </div>
    </div>

    <div id="home" class="view active">
        <div class="content-scroll">
            <div class="logo-wrap">
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="court-logo"></div>
                    <div style="font-weight: 900; font-style: italic; font-size: 20px;">COURT<span style="color:var(--neon)">READY</span></div>
                </div>
                <div id="user-sport-tag" class="sport-tag">...</div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:900; font-size:14px;">
                    <span id="month-label">GENNAIO</span><i data-lucide="calendar" style="width:16px; color:#666;"></i>
                </div>
                <div class="cal-grid" id="calendar-grid"></div>
            </div>

            <div style="padding: 0 20px;">
                <div onclick="showView('train', document.querySelectorAll('.nav-item')[2])" style="background:rgba(212,255,0,0.05); border:1px dashed var(--neon); padding:15px; border-radius:12px; text-align:center; font-size:10px; font-weight:800; color:var(--neon); cursor:pointer;">
                    + REGISTRA ALLENAMENTO EXTRA OGGI
                </div>
            </div>

            <div class="card" style="background: linear-gradient(170deg, #111 0%, #000 100%);">
                <small style="color:#666; font-weight: 800;">CONDITIONING SCORE</small>
                <div style="font-size: 56px; font-weight: 900; margin: 10px 0;" id="main-score">--</div>
                <div id="home-status" style="font-size:11px; color:#888;">Nessun dato recente</div>
            </div>
        </div>
    </div>

    <div id="match" class="view">
        <div class="content-scroll">
            <div style="padding: 40px 25px 15px;"><h2 style="font-size: 28px; font-weight: 900;">Match Lab</h2></div>
            <div class="card">
                <div class="set-container">
                    <div class="set-macro">SET 1<br><div class="score-box"><input type="number" id="s1i" value="0">-<input type="number" id="s1a" value="0"></div></div>
                    <div class="set-macro">SET 2<br><div class="score-box"><input type="number" id="s2i" value="0">-<input type="number" id="s2a" value="0"></div></div>
                    <div class="set-macro">SET 3<br><div class="score-box"><input type="number" id="s3i" value="0">-<input type="number" id="s3a" value="0"></div></div>
                </div>
                <div style="margin:15px 0;">
                    <label style="font-size:10px; font-weight:900; color:#555">FATICA PERCEPITA</label>
                    <input type="range" id="mp" min="0" max="100" value="50" style="width:100%; accent-color:var(--neon);">
                </div>
                <button class="btn-neon" onclick="saveMatch()">SALVA REPORT</button>
            </div>
            <div id="full-history" style="padding: 0 20px;"></div>
        </div>
    </div>

    <div id="train" class="view">
        <div class="content-scroll" id="train-setup">
            <div style="padding: 40px 25px 15px;"><h2 style="font-size: 28px; font-weight: 900;">Train Lab</h2></div>
            <div style="padding:0 20px 20px;">
                <div style="background:#111; border-left:3px solid var(--neon); padding:15px; border-radius:0 10px 10px 0;">
                    <div id="train-advice" style="font-size:12px; color:#ddd; line-height:1.4;">Analisi dati in corso...</div>
                </div>
            </div>
            <div class="card">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <div class="opt-btn active" data-m="15" onclick="setDur(15, this)">15 MIN</div>
                    <div class="opt-btn" data-m="30" onclick="setDur(30, this)">30 MIN</div>
                </div>
                <button class="btn-neon" style="margin-top:20px;" onclick="generateTraining()">GENERA & INIZIA</button>
            </div>
        </div>
        
        <div id="train-list" class="content-scroll" style="display:none; padding: 20px;">
            <div id="exercises-container"></div>
            <button class="btn-neon" onclick="startImmersive()">AVVIA PLAYER CON COACH</button>
        </div>
    </div>

    <div id="immersive-session">
        <div style="height:40vh; background:#111; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--neon);">
            <i data-lucide="zap" style="width:60px; height:60px; color:var(--neon);"></i>
        </div>
        <div style="padding:30px; text-align:center; flex:1;">
            <h2 id="imm-name" style="font-size: 32px; font-weight: 900; margin:0;">PRONTO?</h2>
            <div id="imm-timer" style="font-size: 100px; font-weight: 900; margin: 20px 0; color:var(--neon);">00</div>
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <button onclick="stopImmersive()" style="background:none; border:none; color:#555; font-weight:900; margin-top:40px; cursor:pointer;">ESCI</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="showView('home', this)"><i data-lucide="calendar"></i><span>PLAN</span></div>
        <div class="nav-item" onclick="showView('match', this)"><i data-lucide="trophy"></i><span>MATCH</span></div>
        <div class="nav-item" onclick="showView('train', this)"><i data-lucide="zap"></i><span>TRAIN</span></div>
    </nav>

    <script>
        // --- DATA ---
        let userConfig = JSON.parse(localStorage.getItem('cr_config')) || { sport: null, days: [] };
        let history
