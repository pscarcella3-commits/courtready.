<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CourtReady Pro</title>
    <script src="https://unpkg.com/lucide@0.263.0/dist/umd/lucide.min.js"></script>
    <style>
        :root { 
            --neon: #d4ff00; --bg: #000000; --card: #111111; --border: #222222; 
            --win: #d4ff00; --loss: #ff3333; --future: #333333;
        }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; height: 100%; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* VISTE */
        .view { display: none; height: 100%; width: 100%; flex-direction: column; overflow-y: auto; position: absolute; top: 0; left: 0; }
        .view.active { display: flex; z-index: 2; }
        .content-scroll { padding-bottom: 120px; width: 100%; }

        /* OVERLAYS (Z-INDEX ALTO) */
        #setup-overlay, #match-detail, #immersive-session { 
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: none; flex-direction: column; 
        }

        /* COMPONENTI GRAFICI */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 10px 20px; position: relative; }
        .btn-neon { background: var(--neon); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 900; width: 100%; text-transform: uppercase; cursor: pointer; margin-top: 15px; }
        
        /* CALENDARIO */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-radius: 8px; border: 1px solid transparent; }
        .cal-cell.planned { border-color: var(--future); color: #666; }
        .cal-cell.done { background: rgba(212, 255, 0, 0.1); border-color: var(--win); color: var(--win); }
        .cal-cell.today { background: white; color: black; }

        /* NAVBAR */
        .nav-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; height: 70px; background: rgba(15,15,15,0.95); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #222; z-index: 5000; }
        .nav-item { color: #444; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; font-size: 10px; font-weight: 800; }
        .nav-item.active { color: var(--neon); }

        /* MATCH SPECIFICS */
        .set-macro { flex: 1; background: #080808; border: 1px solid #222; border-radius: 12px; padding: 10px 5px; text-align: center; }
        .score-box input { width: 32px; height: 32px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: var(--neon); text-align: center; font-weight: 900; }
        
        /* TRAIN SPECIFICS */
        .opt-btn { background: #080808; border: 1px solid #222; padding: 12px; border-radius: 12px; color: #666; font-size: 10px; font-weight: 800; cursor: pointer; text-align: center; }
        .opt-btn.active { border-color: var(--neon); color: var(--neon); }
        #imm-timer { font-size: 90px; font-weight: 900; margin: 20px 0; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>

    <div id="setup-overlay">
        <div style="padding: 40px 25px;">
            <h2 style="font-size: 28px; font-weight: 900;">PIANIFICA</h2>
            <p style="color:#666; margin-bottom:30px;">In quali giorni ti alleni?</p>
            <div id="setup-days">
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(1, this)">Lunedì</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(2, this)">Martedì</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(3, this)">Mercoledì</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(4, this)">Giovedì</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(5, this)">Venerdì</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(6, this)">Sabato</button>
                <button class="btn-neon" style="background:#111; color:white; margin-bottom:10px;" onclick="toggleDay(0, this)">Domenica</button>
            </div>
            <button class="btn-neon" onclick="finishSetup()">CONFERMA</button>
        </div>
    </div>

    <div id="home" class="view active">
        <div class="content-scroll">
            <div style="padding: 40px 25px 10px; font-weight: 900; font-size: 20px;">COURT<span style="color:var(--neon)">READY</span></div>
            <div class="card">
                <small style="color:#666; font-weight: 800;">CONDITIONING SCORE</small>
                <div style="font-size: 56px; font-weight: 900;" id="main-score">--</div>
            </div>
            <div class="card">
                <b id="month-label">---</b>
                <div class="cal-grid" id="main-calendar"></div>
            </div>
        </div>
    </div>

    <div id="match" class="view">
        <div class="content-scroll">
            <div style="padding: 40px 25px 15px;"><h2 style="font-size: 28px; font-weight: 900;">Match Lab</h2></div>
            <div class="card">
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <div class="set-macro"><span>SET 1</span><br><input type="number" id="s1i" value="0"> - <input type="number" id="s1a" value="0"></div>
                    <div class="set-macro"><span>SET 2</span><br><input type="number" id="s2i" value="0"> - <input type="number" id="s2a" value="0"></div>
                    <div class="set-macro"><span>SET 3</span><br><input type="number" id="s3i" value="0"> - <input type="number" id="s3a" value="0"></div>
                </div>
                <textarea id="m-notes" placeholder="Note tattiche..." style="width:100%; background:#080808; border:1px solid #222; color:white; padding:10px; border-radius:12px;"></textarea>
                <button class="btn-neon" onclick="saveMatch()">SALVA MATCH</button>
            </div>
            <div id="full-history" style="padding: 0 20px;"></div>
        </div>
    </div>

    <div id="train" class="view">
        <div class="content-scroll" id="train-setup">
            <div style="padding: 40px 25px 15px;"><h2 style="font-size: 28px; font-weight: 900;">Train Lab</h2></div>
            <div class="card">
                <label style="font-size:10px; font-weight:900;">DURATA</label>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin:10px 0;">
                    <div class="opt-btn active" data-m="10" onclick="selectDur(this)">10M</div>
                    <div class="opt-btn" data-m="20" onclick="selectDur(this)">20M</div>
                    <div class="opt-btn" data-m="30" onclick="selectDur(this)">30M</div>
                </div>
                <button class="btn-neon" onclick="generateTraining()">GENERA</button>
            </div>
            <div id="exercises-container" style="padding:0 20px;"></div>
            <button id="start-btn" class="btn-neon" style="display:none; margin: 20px;" onclick="startPlayer()">AVVIA SESSIONE</button>
        </div>
    </div>

    <div id="immersive-session">
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center;">
            <h2 id="imm-name" style="text-transform:uppercase;">EXERCISE</h2>
            <div id="imm-timer">00</div>
            <button class="btn-neon" style="background:#ff3333; color:white;" onclick="stopPlayer()">STOP</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="showV('home', this)"><i data-lucide="home"></i><span>HOME</span></div>
        <div class="nav-item" onclick="showV('match', this)"><i data-lucide="trophy"></i><span>MATCH</span></div>
        <div class="nav-item" onclick="showV('train', this)"><i data-lucide="zap"></i><span>TRAIN</span></div>
    </nav>

    <script>
        let matches = JSON.parse(localStorage.getItem('cr_matches')) || [];
        let scheduledDays = JSON.parse(localStorage.getItem('cr_days')) || [];
        let selectedDuration = 10;
        let trainingPlan = [];
        let curEx = 0;
        let timer;

        // Inizializzazione icone
        function refreshIcons() { if(window.lucide) lucide.createIcons(); }

        // Gestione Viste
        function showV(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'home') renderHome();
            refreshIcons();
        }

        // Setup Giorni
        function toggleDay(d, btn) {
            const i = scheduledDays.indexOf(d);
            if(i > -1) { scheduledDays.splice(i,1); btn.style.borderColor = 'transparent'; }
            else { scheduledDays.push(d); btn.style.borderColor = 'var(--neon)'; }
        }
        function finishSetup() {
            localStorage.setItem('cr_days', JSON.stringify(scheduledDays));
            document.getElementById('setup-overlay').style.display = 'none';
            renderHome();
        }

        // Home & Calendario
        function renderHome() {
            const now = new Date();
            const grid = document.getElementById('main-calendar');
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            let html = '';
            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(now.getFullYear(), now.getMonth(), d);
                let status = scheduledDays.includes(date.getDay()) ? 'planned' : '';
                if(d === now.getDate()) status = 'today';
                html += `<div class="cal-cell ${status}">${d}</div>`;
            }
            grid.innerHTML = html;
            document.getElementById('month-label').innerText = now.toLocaleString('it-IT', {month:'long'});
            
            // Fix del crash: controllo se ci sono match
            if(matches.length > 0) {
                document.getElementById('main-score').innerText = "85";
            } else {
                document.getElementById('main-score').innerText = "--";
            }
        }

        // Match Lab
        function saveMatch() {
            const m = {
                id: Date.now(),
                s1i: document.getElementById('s1i').value,
                s1a: document.getElementById('s1a').value,
                notes: document.getElementById('m-notes').value,
                date: new Date().toLocaleDateString()
            };
            matches.unshift(m);
            localStorage.setItem('cr_matches', JSON.stringify(matches));
            alert("Match salvato!");
            showV('home');
        }

        // Train Lab
        function selectDur(el) {
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            selectedDuration = parseInt(el.dataset.m);
        }

        function generateTraining() {
            trainingPlan = [
                {n: "Riscaldamento", t: 30},
                {n: "Shadow Swing", t: 45},
                {n: "Squat Jump", t: 30}
            ];
            const container = document.getElementById('exercises-container');
            container.innerHTML = trainingPlan.map(ex => `
                <div class="card" style="margin:5px 0; padding:10px;">
                    <b>${ex.n}</b> - ${ex.t}s
                </div>
            `).join('');
            document.getElementById('start-btn').style.display = 'block';
        }

        function startPlayer() {
            curEx = 0;
            document.getElementById('immersive-session').style.display = 'flex';
            playEx();
        }

        function playEx() {
            if(curEx >= trainingPlan.length) return stopPlayer();
            const ex = trainingPlan[curEx];
            document.getElementById('imm-name').innerText = ex.n;
            let time = ex.t;
            document.getElementById('imm-timer').innerText = time;
            
            timer = setInterval(() => {
                time--;
                document.getElementById('imm-timer').innerText = time;
                if(time <= 0) {
                    clearInterval(timer);
                    curEx++;
                    playEx();
                }
            }, 1000);
        }

        function stopPlayer() {
            clearInterval(timer);
            document.getElementById('immersive-session').style.display = 'none';
        }

        window.onload = () => {
            if(scheduledDays.length === 0) document.getElementById('setup-overlay').style.display = 'flex';
            renderHome();
            refreshIcons();
        };
    </script>
</body>
</html>
