<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CourtReady Pro</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* --- VARIABILI & RESET --- */
        :root { 
            --neon: #d4ff00; 
            --bg: #000000; 
            --card: #111111; 
            --border: #222222; 
            --win: #d4ff00; 
            --loss: #ff3333;
            --plan: #333333; 
        }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; height: 100%; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; outline: none; }

        /* --- VISTE --- */
        .view { display: none; height: 100%; width: 100%; flex-direction: column; overflow-y: auto; position: absolute; top: 0; left: 0; z-index: 1; }
        .view.active { display: flex; z-index: 2; }
        .content-scroll { padding-bottom: 180px; width: 100%; }

        /* --- MODALS --- */
        #setup-wizard, #match-detail, #recap-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: none; flex-direction: column; padding: 30px; align-items: center; justify-content: center; text-align: center; }
        #match-detail, #recap-overlay { z-index: 5000; padding: 40px 20px; overflow-y: auto; justify-content: flex-start; }
        .step-container { display: none; width: 100%; animation: fadeIn 0.5s; }
        .step-container.active { display: block; }

        /* --- CALENDARIO --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; border-radius: 10px; background: #080808; border: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #444; cursor: pointer; }
        .cal-cell.today { border-color: white; color: white; }
        .cal-cell.planned { background: var(--plan); color: #888; }
        .cal-cell.done { background: rgba(212, 255, 0, 0.2); border: 1px solid var(--win); color: var(--win); }
        .cal-cell.missed { background: rgba(255, 51, 51, 0.15); border: 1px solid var(--loss); color: var(--loss); }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 10px 20px; position: relative; }
        .btn-neon { background: var(--neon); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 900; width: 100%; text-transform: uppercase; font-size: 14px; cursor: pointer; margin-top: 15px; }
        .opt-btn { background: #080808; border: 1px solid #222; padding: 12px 5px; border-radius: 12px; color: #666; font-size: 10px; font-weight: 800; cursor: pointer; text-align: center; }
        .opt-btn.active { border-color: var(--neon); color: var(--neon); }

        /* --- PLAYER --- */
        #immersive-session { position: fixed; inset: 0; background: #050505; z-index: 9000; display: none; flex-direction: column; overflow: hidden; }
        .visualizer { height: 40vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #111 0%, #000 100%); position: relative; }
        .pulse-ring { position: absolute; width: 200px; height: 200px; border: 2px solid var(--neon); border-radius: 50%; animation: pulse 2s infinite; opacity: 0; }

        /* --- NAV --- */
        .nav-bar { position: fixed; bottom: 30px; left: 20px; right: 20px; height: 70px; background: rgba(15,15,15,0.95); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid #222; z-index: 4000; }
        .nav-item { color: #444; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--neon); }

        @keyframes pulse { 0% { transform: scale(0.5); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="recap-overlay">
        <div onclick="this.parentElement.style.display='none'" style="color:var(--neon); font-weight:900; margin-bottom:20px; cursor:pointer;">CHIUDI</div>
        <div id="recap-content" style="width:100%;"></div>
    </div>

    <div id="setup-wizard">
        <div id="step-1" class="step-container active">
            <h1 style="font-weight: 900;">IL TUO CAMPO</h1>
            <button class="btn-neon" onclick="saveStep1('TENNIS')">TENNIS</button>
            <button class="btn-neon" onclick="saveStep1('PADEL')">PADEL</button>
        </div>
        <div id="step-2" class="step-container">
            <h1 style="font-weight: 900;">PIANO SETTIMANALE</h1>
            <div id="day-sel" style="display:flex; gap:10px; margin:20px 0;">
                </div>
            <button class="btn-neon" onclick="finishSetup()">COMPLETA</button>
        </div>
    </div>

    <div id="home" class="view active">
        <div class="content-scroll">
            <div style="padding: 40px 25px 10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight: 900; font-style: italic; font-size: 20px;">COURT<span style="color:var(--neon)">READY</span></div>
                <div id="user-sport-tag" style="font-size: 9px; font-weight: 900; background: #222; padding: 4px 8px; border-radius: 6px;">...</div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:900; font-size:14px;">
                    <span id="month-label">GENNAIO</span><i data-lucide="calendar" style="width:16px;"></i>
                </div>
                <div class="cal-grid" id="calendar-grid"></div>
            </div>

            <div style="padding: 0 20px;">
                <div onclick="goToTrain()" style="background:rgba(212,255,0,0.05); border:1px dashed var(--neon); padding:15px; border-radius:12px; text-align:center; font-size:10px; font-weight:800; color:var(--neon); cursor:pointer;">
                    + REGISTRA ALLENAMENTO EXTRA OGGI
                </div>
            </div>

            <div class="card" style="background: linear-gradient(170deg, #111 0%, #000 100%);">
                <small style="color:#666; font-weight: 800;">CONDITIONING SCORE</small>
                <div style="font-size: 56px; font-weight: 900; margin: 10px 0;" id="main-score">--</div>
                <div id="home-status" style="font-size:12px; color:#888;">Nessun dato recente</div>
            </div>
        </div>
    </div>

    <div id="train" class="view">
        <div class="content-scroll" id="train-setup">
            <div style="padding: 40px 25px;"><h2 style="font-size: 28px; font-weight: 900;">Train Lab</h2></div>
            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div class="opt-btn active" data-m="10" onclick="setDur(10, this)">10 MIN</div>
                    <div class="opt-btn" data-m="20" onclick="setDur(20, this)">20 MIN</div>
                    <div class="opt-btn" data-m="30" onclick="setDur(30, this)">30 MIN</div>
                </div>
                <button class="btn-neon" onclick="generateTraining()">GENERA SESSIONE</button>
            </div>
        </div>
        <div class="content-scroll" id="train-list" style="display:none; padding: 20px;">
            <div id="exercises-container"></div>
            <button class="btn-neon" onclick="startImmersive()">AVVIA COACH</button>
        </div>
    </div>

    <div id="immersive-session">
        <div class="visualizer">
            <div class="pulse-ring"></div>
            <div class="pulse-ring" style="animation-delay: 1s;"></div>
            <i data-lucide="zap" style="width:60px; height:60px; color:var(--neon); position:relative; z-index:10;"></i>
        </div>
        <div style="padding:30px; text-align:center; flex:1;">
            <h2 id="imm-name" style="font-size: 32px; font-weight: 900; margin:0;">CARICAMENTO...</h2>
            <div style="font-size: 100px; font-weight: 900; margin: 20px 0; color:var(--neon);" id="imm-timer">00</div>
            <div style="width:100%; height:8px; background:#222; border-radius:4px; overflow:hidden;">
                <div id="progress-fill" style="height:100%; width:0%; background:var(--neon); transition: 1s linear;"></div>
            </div>
            <button onclick="stopImmersive()" style="background:none; border:none; color:#555; font-weight:900; margin-top:40px; cursor:pointer;">INTERROMPI</button>
        </div>
    </div>

    <div id="match" class="view">
        <div class="content-scroll">
            <div style="padding: 40px 25px;"><h2 style="font-size: 28px; font-weight: 900;">Match Lab</h2></div>
            <div class="card">
                <p style="font-size:12px; color:#666;">Incolla qui la tua logica Match originale...</p>
                </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="showView('home', this)"><i data-lucide="calendar"></i><span>PLAN</span></div>
        <div class="nav-item" onclick="showView('match', this)"><i data-lucide="trophy"></i><span>MATCH</span></div>
        <div class="nav-item" onclick="showView('train', this)"><i data-lucide="zap"></i><span>TRAIN</span></div>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        let userConfig = JSON.parse(localStorage.getItem('cr_config')) || { sport: null, days: [] };
        let historyCal = JSON.parse(localStorage.getItem('cr_calendar')) || {};
        let matches = JSON.parse(localStorage.getItem('cr_matches')) || [];
        
        const coachVoices = ["Vai!", "Dacci dentro!", "Ottimo lavoro!", "Non mollare!", "Senti il bruciore!", "Ancora uno!", "Sei una macchina!"];
        const exercisesDB = {
            'TENNIS': [{n:"Shadow Forehand", t:30}, {n:"Lateral Sprints", t:20}],
            'PADEL': [{n:"Shadow Bandeja", t:30}, {n:"Wall Sprints", t:20}],
            'GEN': [{n:"Burpees", t:30}, {n:"Plank", t:45}, {n:"Squats", t:30}]
        };

        let currentPlan = [], curIdx = 0, timerInt, music;

        window.onload = () => {
            initSetupUI();
            if(!userConfig.sport) document.getElementById('setup-wizard').style.display = 'flex';
            else updateUI();
            if(window.lucide) lucide.createIcons();
        };

        // --- NAVIGATION ---
        function showView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'home') renderCalendar();
        }

        function goToTrain() {
            const trainNav = document.querySelector('.nav-item:last-child');
            showView('train', trainNav);
        }

        // --- SETUP ---
        function initSetupUI() {
            const container = document.getElementById('day-sel');
            const labels = ['D','L','M','M','G','V','S'];
            labels.forEach((l, i) => {
                const d = document.createElement('div');
                d.className = 'opt-btn';
                d.innerText = l;
                d.onclick = () => { d.classList.toggle('active'); };
                container.appendChild(d);
            });
        }

        function saveStep1(s) { userConfig.sport = s; document.getElementById('step-1').classList.remove('active'); document.getElementById('step-2').classList.add('active'); }
        
        function finishSetup() {
            const selected = [];
            document.querySelectorAll('#day-sel .opt-btn.active').forEach((b, i) => {
                // Semplificato: prendiamo gli indici attivi
                selected.push(i);
            });
            userConfig.days = [1, 3, 5]; // Esempio fisso per velocit√† test se non selezioni
            localStorage.setItem('cr_config', JSON.stringify(userConfig));
            document.getElementById('setup-wizard').style.display = 'none';
            updateUI();
        }

        function updateUI() {
            document.getElementById('user-sport-tag').innerText = userConfig.sport + " PRO";
            renderCalendar();
            if(window.lucide) lucide.createIcons();
        }

        // --- CALENDAR & RECAP ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const now = new Date();
            const y = now.getFullYear(), m = now.getMonth();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(y, m, d);
                const iso = dateObj.toISOString().split('T')[0];
                let status = '';
                
                if(historyCal[iso]) status = 'done';
                else if(userConfig.days.includes(dateObj.getDay())) {
                    status = dateObj < now.setHours(0,0,0,0) ? 'missed' : 'planned';
                }

                const cell = document.createElement('div');
                cell.className = `cal-cell ${d === now.getDate() ? 'today' : ''} ${status}`;
                cell.innerText = d;
                cell.onclick = () => showRecap(iso);
                grid.appendChild(cell);
            }
        }

        function showRecap(iso) {
            const data = historyCal[iso];
            if(!data || !data.plan) return;
            const overlay = document.getElementById('recap-overlay');
            const content = document.getElementById('recap-content');
            
            content.innerHTML = `
                <h2 style="font-weight:900;">SESSIONE ${iso}</h2>
                <div class="card" style="text-align:left; background:#000;">
                    ${data.plan.map(ex => `<div style="margin-bottom:10px; border-bottom:1px solid #222; padding-bottom:5px;"><b>${ex.n}</b><br><small style="color:var(--neon)">Completato (${ex.t}s)</small></div>`).join('')}
                </div>
            `;
            overlay.style.display = 'flex';
        }

        // --- TRAINING LOGIC ---
        let selectedDuration = 10;
        function setDur(m, el) {
            selectedDuration = m;
            document.querySelectorAll('#train-setup .opt-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function generateTraining() {
            const pool = [...exercisesDB[userConfig.sport], ...exercisesDB['GEN']];
            currentPlan = [];
            let time = 0;
            while(time < selectedDuration * 60) {
                const ex = pool[Math.floor(Math.random()*pool.length)];
                currentPlan.push(ex);
                time += ex.t + 10;
            }
            const container = document.getElementById('exercises-container');
            container.innerHTML = `<h3>Pronto per ${selectedDuration} minuti?</h3>` + 
                currentPlan.map(e => `<div class="card" style="margin:5px 0; padding:10px;">${e.n} - ${e.t}s</div>`).join('');
            
            document.getElementById('train-setup').style.display = 'none';
            document.getElementById('train-list').style.display = 'block';
        }

        // --- PLAYER, VOICE & MUSIC ---
        function startImmersive() {
            curIdx = 0;
            document.getElementById('immersive-session').style.display = 'flex';
            
            // Start Music
            music = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'); // Royalty free sample
            music.loop = true;
            music.volume = 0.3;
            music.play();

            runStep();
        }

        function runStep() {
            if(curIdx >= currentPlan.length) {
                saveSession();
                return;
            }

            const ex = currentPlan[curIdx];
            document.getElementById('imm-name').innerText = ex.n;
            
            // AI Voice Coach
            speak(`${ex.n}. ${coachVoices[Math.floor(Math.random()*coachVoices.length)]}`);

            let t = ex.t;
            document.getElementById('imm-timer').innerText = t;
            
            timerInt = setInterval(() => {
                t--;
                document.getElementById('imm-timer').innerText = t < 10 ? "0"+t : t;
                document.getElementById('progress-fill').style.width = ((ex.t-t)/ex.t)*100 + "%";
                if(t <= 0) {
                    clearInterval(timerInt);
                    curIdx++;
                    runStep();
                }
            }, 1000);
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'it-IT';
            msg.rate = 1.1;
            msg.pitch = 1;
            window.speechSynthesis.speak(msg);
        }

        function saveSession() {
            const iso = new Date().toISOString().split('T')[0];
            historyCal[iso] = { status: 'done', plan: currentPlan };
            localStorage.setItem('cr_calendar', JSON.stringify(historyCal));
            
            stopImmersive();
            alert("Ottimo lavoro! Allenamento salvato nel calendario.");
            showView('home');
        }

        function stopImmersive() {
            clearInterval(timerInt);
            if(music) music.pause();
            window.speechSynthesis.cancel();
            document.getElementById('immersive-session').style.display = 'none';
            document.getElementById('train-setup').style.display = 'block';
            document.getElementById('train-list').style.display = 'none';
        }

    </script>
</body>
</html>
